<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Calculator</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="wrapper">

    </div>
    <script>
// TODO add change skins functionality, add buttons for that
      document.addEventListener('DOMContentLoaded', (event) => {
        const calculator = new Calculator();
        calculator.drawScreen();
        calculator.drawButtonSecton();
      });

      class Calculator {
        constructor() {
          this.buttons = [{'CE': 'global clear'}, {'C': 'clear'}, {'NEG': 'negative'}, {'/': 'divide'},
          {'7': '7'}, {'8': '8'}, {'9': '9'}, {'*': 'multiply'}, {'4': '4'}, {'5': '5'}, {'6': '6'},
          {'-': 'subtract'}, {'1': '1'}, {'2': '2'}, {'3': '3'}, {'+': 'add'}, {'0': '0'}, {'.': 'point'},
          {'%': 'percent'}, {'=': 'equals'}];
          this.total = 0;
          this.lastOperation = '';
          this.subtotal = 0; // window top part
          this.currentNumber = 0; // window bottom part
        }

        drawScreen() {
          const wrapperDiv = document.getElementById('wrapper');
          const screenDiv = document.createElement('div');
          screenDiv.setAttribute('id', 'screen');
          const topPartScreen = document.createElement('div');
          topPartScreen.setAttribute('id', 'top-section');

          const bottomPartScreen = document.createElement('div');
          bottomPartScreen.setAttribute('id', 'bottom-section');
          
          screenDiv.appendChild(topPartScreen);
          screenDiv.appendChild(bottomPartScreen);
          wrapperDiv.appendChild(screenDiv);
          
        }
        
        drawButtonSecton() {
          const wrapperDiv = document.getElementById('wrapper');
          wrapperDiv.setAttribute('id', 'wrapper');
          const buttonsDiv = document.createElement('div');
          buttonsDiv.classList.add('btn-wrapper');

          wrapperDiv.appendChild(buttonsDiv);
          document.body.appendChild(wrapperDiv);
          this.createButtons();
        }

        isAnOperation(dataId) {
          return Number.isNaN(parseInt(dataId, 10));
        }

        createButtons() {
          // C - global clear
          // ce - clear entry
          const buttonTags = this.buttons;
          
          const buttonWrapperDiv = document.querySelector('.btn-wrapper');
          buttonTags.forEach(obj => {
            const tag = Object.values(obj)[0];
            const value = Object.keys(obj)[0];

            const button = document.createElement('span');
            button.classList.add('btn');
            button.setAttribute('data-id', tag);
            button.textContent = value;
            if (['C', 'CE'].includes(value)) {
              button.classList.add('c-ce');
            } else if (['/', '*', '+', '-', '='].includes(value)) {
              button.classList.add('op');
            }

            buttonWrapperDiv.appendChild(button);
          });
          this.addButtonFunctionality();
        }

        addButtonFunctionality() {
          const buttonWrapperDiv = document.querySelector('.btn-wrapper');

          buttonWrapperDiv.addEventListener('click', event => {
            // extract this callback
            event.stopPropagation();
            const target = event.target;
            
            if (target.classList.contains('btn')) {
              const dataIdAttr = target.getAttribute('data-id');
              // console.log(dataIdAttr);

              if (this.isAnOperation(dataIdAttr)) {
                this.handleOperation(dataIdAttr);

              } else { // it is a number
                let pressedDigit = parseInt(target.textContent, 10);

                if (this.lastOperation === '=') {
                  this.total = 0;
                  this.lastOperation = '';
                  this.subtotal = 0;
                  this.currentNumber = pressedDigit;
                } else {
                  if (this.currentNumber === 0 || this.lastOperation) {
                    this.currentNumber = pressedDigit;
                  } else {
                    this.currentNumber = Number(String(this.currentNumber) + String(pressedDigit));
                  }
                }


                
              }
            }
            this.redrawCalculatorScreen();
            console.log(this);
          })
        }

        handleOperation(op) {
          // console.log(op);
          switch (op) {
            case 'global clear':
              this.handleGlobalClear();
              break;

            case 'clear':
              this.handleClear();
              break;

            case 'negative':
              this.handleNegative();
              break;

            case 'divide':
              this.setLastOperation('/');
              break;

            case 'multiply':
              this.setLastOperation('*');
                break;

            case 'subtract':
              this.setLastOperation('-');
              break;

            case 'add':
                this.setLastOperation('+');
              break;

            case 'point':
              // TODO
              break;

            case 'percent':
              // TODO
              break;

            case 'equals':
              this.handleEquals();
              break;
            default:
              throw new Error('Unknown operation');

          }
        }
        handleGlobalClear() {
          // console.log('clicked global clear');
          this.total = 0;
          this.subtotal = 0;
          this.currentNumber = 0;
          this.lastOperation = '';
        }

        handleClear() {
          this.currentNumber = 0;
        }

        handleNegative() {
          this.currentNumber = Math.abs(this.currentNumber) * -1;
        }

        setLastOperation(op) {
          this.lastOperation = op;
          this.subtotal = this.currentNumber;
        }

        handleEquals() {
          // console.log('clicked equals');
          if (this.lastOperation) {
            if (this.subtotal === 0) {
              this.subtotal = this.currentNumber;
            }

            switch (this.lastOperation) {
              case '/':
                this.total = this.subtotal / this.currentNumber;
                break;

              case '*':
                this.total = this.subtotal * this.currentNumber;
                break;

              case '-':
                this.total = this.subtotal - this.currentNumber;
                break;

              case '+':
                this.total = this.subtotal + this.currentNumber;
                break;
            }
            this.currentNumber = this.total; 
            this.subtotal = this.total;
            this.lastOperation = '=';

          } else {
            //
          }
          // console.log(this)
        }

        redrawCalculatorScreen() {
          const resultSectionScreen = document.getElementById('bottom-section');
          resultSectionScreen.textContent = this.total || this.currentNumber;
        }

      }
    </script>
  </body>
</html>
